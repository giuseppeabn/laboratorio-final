name: DevSecOps Pipeline

on:
  push:
    branches:
      - devsecops-pipeline

jobs:
  sast:
    name: Análisis SAST (SonarCloud)
    runs-on: ubuntu-latest
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        with:
          args: >
              -Dsonar.projectKey=${{ github.repository_owner }}_${{ github.event.repository.name }}
              -Dsonar.organization=${{ github.repository_owner }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Subir reporte Sonar (opcional si quieres adjuntar logs)
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: sonar-report
          path: .scannerwork # adjuntar los archivos de Sonar

  sca:
    name: Análisis SCA (Dependency Check)
    runs-on: ubuntu-latest
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3

      - name: Instalar dependencias Node
        run: npm install

      - name: Ejecutar Dependency Check
        run: |
          mkdir -p dependency-check-report
          docker run --rm -v "$GITHUB_WORKSPACE:/src" owasp/dependency-check \
            --scan /src \
            --format "ALL" \
            --out /src/dependency-check-report \
            --failOnCVSS 5.0

      - name: Subir reporte Dependency Check
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dependency-check-report
          path: dependency-check-report

  build:
    name: Construcción de Imagen Docker
    runs-on: ubuntu-latest
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3

      - name: Construir imagen
        run: docker build -t movies-app .

  image-security:
    name: Análisis de Seguridad de Imagen (Trivy)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3

      - name: Construir imagen (requerido para análisis)
        run: docker build -t movies-app .

      - name: Análisis con Trivy
        run: |
           docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --severity CRITICAL,HIGH,MEDIUM movies-app || true

      - name: Subir reporte Trivy
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: trivy-report
          path: trivy-report.txt
        continue-on-error: true

  deploy:
    name: Despliegue Local
    runs-on: ubuntu-latest
    needs: image-security
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3

      - name: Construir imagen
        run: docker build -t movies-app .

      - name: Desplegar en Docker
        run: docker run -d -p 8080:8080 movies-app

  dast:
    name: Análisis DAST (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Descargar imagen OWASP ZAP
        run: docker pull owasp/zap2docker-stable

      - name: OWASP ZAP Scan
        run: |
          docker run -t owasp/zap2docker-stable zap-baseline.py -t http://localhost:8080 -r zap_report.html || true

      - name: Subir reporte OWASP ZAP
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: zap-report
          path: zap_report.html

